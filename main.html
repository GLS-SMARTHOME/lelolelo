<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Live Map with User Location</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 100%;
      width: 100%;
    }

    /* Dropdown menu */
    .menu {
      position: fixed;
      top: env(safe-area-inset-top, 16px);
      right: env(safe-area-inset-right, 16px);
      z-index: 5;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .menu-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.1);
      background: #ffffff;
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
      cursor: pointer;
    }
    .menu-btn span { font-weight: 600; }
    .chev {
      width: 0; height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 7px solid #111827;
      transition: transform .18s ease;
    }
    .menu.open .chev { transform: rotate(180deg); }

    .menu-list {
      position: absolute;
      right: 0;
      margin-top: 8px;
      min-width: 180px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.18);
      display: none;
    }
    .menu.open .menu-list { display: block; }

    .menu-item {
      padding: 12px 14px;
      font-size: 15px;
      cursor: pointer;
      transition: background .12s ease;
    }
    .menu-item:hover { background: #f3f4f6; }

    /* Pulsing user dot */
    .pulse {
      width: 20px;
      height: 20px;
      background: #3b82f6;
      border-radius: 50%;
      position: relative;
    }
    .pulse::after {
      content: "";
      width: 40px;
      height: 40px;
      border-radius: 50%;
      position: absolute;
      top: -10px;
      left: -10px;
      background: rgba(59,130,246,0.3);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(0.8); opacity: 1; }
      100% { transform: scale(2); opacity: 0; }
    }

    /* Recenter button */
    .recenter-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 10;
      background: #3b82f6;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    .recenter-btn:hover { background: #2563eb; }
  </style>
</head>
<body>
  
  <!-- Dropdown menu -->
  <div class="menu" id="menu">
    <button class="menu-btn" id="menuBtn">
      <span>Menu</span>
      <div class="chev"></div>
    </button>
    <div class="menu-list">
      <div class="menu-item" data-action="vendre">Vendre</div>
      <div class="menu-item" data-action="location">Location</div>
      <div class="menu-item" data-action="course">Course</div>
    </div>
  </div>

  <!-- Map -->
  <div id="map"></div>

<!-- Add this inside <body> after your map div -->

<!-- Vendre Form Modal -->
<div id="vendreModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
  background:rgba(0,0,0,0.5); z-index:20; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border-radius:12px; width:90%; max-width:400px; position:relative;">
    <h2>Vendre Item</h2>
    <label>Title (Phone, Car, Shoe):</label>
    <input type="text" id="itemTitle" placeholder="Title" style="width:100%; margin-bottom:10px;"/>
    <label>Price:</label>
    <input type="number" id="itemPrice" placeholder="Price" style="width:100%; margin-bottom:10px;"/>
    <label>Detail:</label>
    <textarea id="itemDetail" placeholder="Detail" style="width:100%; margin-bottom:10px;"></textarea>
    <label>Phone Number:</label>
    <input type="text" id="itemPhone" placeholder="Phone Number" style="width:100%; margin-bottom:10px;"/>
    <label>Pictures:</label>
    <input type="file" id="itemPictures" multiple style="margin-bottom:10px;"/>
    <button id="saveItemBtn" style="width:100%; padding:10px; background:#3b82f6; color:#fff; border:none; border-radius:8px;">Save</button>
    <button onclick="closeModal()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:18px;">&times;</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
  // Firebase config
 const firebaseConfig = {
  apiKey: "AIzaSyAIlkvwyaF6FPPbXBJDqHwuTS5S3QKG3l8",
  authDomain: "xoxo-store.firebaseapp.com",
  databaseURL: "https://xoxo-store-default-rtdb.firebaseio.com",
  projectId: "xoxo-store",
  storageBucket: "xoxo-store.firebasestorage.app",
  messagingSenderId: "667290233046",
  appId: "1:667290233046:web:dbbc9130ff38b0900f8177",
  measurementId: "G-XMJVCK8KMD"
};
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const storage = firebase.storage();

  // Open modal when Vendre clicked
  document.querySelector('[data-action="vendre"]').addEventListener('click', () => {
    document.getElementById('vendreModal').style.display = 'flex';
    menu.classList.remove('open');
  });

  function closeModal() {
    document.getElementById('vendreModal').style.display = 'none';
  }

  // Save button
  document.getElementById('saveItemBtn').addEventListener('click', async () => {
    const title = document.getElementById('itemTitle').value.trim();
    const price = document.getElementById('itemPrice').value.trim();
    const detail = document.getElementById('itemDetail').value.trim();
    const phone = document.getElementById('itemPhone').value.trim();
    const pictures = document.getElementById('itemPictures').files;

    if (!title || !price || !detail || !phone) {
      alert("Please fill all fields.");
      return;
    }

    if (!currentPos) {
      alert("Location not found yet.");
      return;
    }

    const lat = currentPos.lat();
    const lng = currentPos.lng();

    // Upload pictures to Firebase Storage
    let pictureURLs = [];
    for (let i = 0; i < pictures.length; i++) {
      const file = pictures[i];
      const storageRef = storage.ref().child(`items/${phone}/${Date.now()}_${file.name}`);
      await storageRef.put(file);
      const url = await storageRef.getDownloadURL();
      pictureURLs.push(url);
    }

    // Save to RTDB
    const itemRef = db.ref(`${phone}/${title}`);
    await itemRef.set({
      price,
      detail,
      pictures: pictureURLs,
      lat,
      lng
    });

    alert("Item saved successfully!");
    closeModal();
  });
</script>


  <!-- Recenter button -->
  <button class="recenter-btn" id="recenterBtn">&#128269;</button>

  <script>
    // Dropdown toggle
    const menu = document.getElementById("menu");
    const menuBtn = document.getElementById("menuBtn");

    menuBtn.addEventListener("click", () => {
      menu.classList.toggle("open");
    });

    document.addEventListener("click", (e) => {
      if (!menu.contains(e.target)) {
        menu.classList.remove("open");
      }
    });

    // Google Maps + pulsing dot
    let map, userOverlay, currentPos;
    let firstLocation = true; // track first location to center map

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 14,
        center: { lat: 20, lng: 0 }, // fallback
        disableDefaultUI: true,
      });

      // Overlay for pulsing dot
      function UserOverlay(position, map) {
        this.position = position;
        this.div = null;
        this.setMap(map);
      }

      UserOverlay.prototype = new google.maps.OverlayView();

      UserOverlay.prototype.onAdd = function () {
        const div = document.createElement("div");
        div.className = "pulse";
        this.div = div;
        const panes = this.getPanes();
        panes.overlayLayer.appendChild(div);
      };

      UserOverlay.prototype.draw = function () {
        if (!this.div) return;
        const overlayProjection = this.getProjection();
        const pos = overlayProjection.fromLatLngToDivPixel(this.position);
        this.div.style.left = pos.x - 10 + "px";
        this.div.style.top = pos.y - 10 + "px";
        this.div.style.position = "absolute";
      };

      UserOverlay.prototype.onRemove = function () {
        if (this.div) {
          this.div.parentNode.removeChild(this.div);
          this.div = null;
        }
      };

      // Geolocation tracking
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
          (pos) => {
            currentPos = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
            if (!userOverlay) {
              userOverlay = new UserOverlay(currentPos, map);
            } else {
              userOverlay.position = currentPos;
              userOverlay.draw();
            }

            // Center map on first location only
            if (firstLocation) {
              map.setCenter(currentPos);
              firstLocation = false;
            }
          },
          (err) => {
            console.warn("Geolocation error:", err.message);
            alert("Please allow location access in your browser.");
          },
          { enableHighAccuracy: true }
        );
      } else {
        alert("Geolocation not supported in this browser.");
      }

      // Recenter button
      const recenterBtn = document.getElementById("recenterBtn");
      recenterBtn.addEventListener("click", () => {
        if (currentPos) {
          map.setCenter(currentPos);
        }
      });
    }
  </script>

  <!-- Google Maps API (replace YOUR_API_KEY) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDjdnkFWOnh1u2cWf5RFURytU8Zk3fmOhk&callback=initMap" async defer></script>
</body>
</html>
